#include <stdio.h>
#include <string.h>

// 清理资源，主要是用于绕过栈保护
int shellcode(void) ;

typedef int (*PFN_INT)(void) ;

#define MAX_SIZE (4096)

int AnalogStackOver(char *pBuf, int nSize) ;

int ConstructionStackOverData(PFN_INT pshellcode, char *pBuf, int nSize) ;

int main(int argc, char **argv)
{
    char buf[MAX_SIZE] = {'A'} ;
    if( ConstructionStackOverData(shellcode, buf, MAX_SIZE))
    {
        AnalogStackOver(buf, MAX_SIZE) ;
    }
    
    return 0 ;
}

int AnalogStackOver(char *pBuf, int nSize)
{
    char buf[16] ={0} ;
    memcpy(buf, pBuf, nSize) ;
    return 0 ;
}

int ConstructionStackOverData(PFN_INT pshellcode, char *pBuf, int nSize)
{
    long long *p = pBuf ;
    int i = 0;
    for(; i < nSize; ++i)
        pBuf[i] = i & 0xff ;

    #if defined (__arm64__) || defined (__aarch64__)
        p[3] = pshellcode ;
    #elif defined(__x86_64__)
        p[3] = pshellcode ;
    #endif

    return 1 ;
}

int shellcode(void)
{
    printf("Hello, World!\r\n") ;
    return 0 ;
}
